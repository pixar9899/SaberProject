<!DOCTYPE html>

<html>

<head>
	<title>midi test</title>
	<link type="text/css" rel="stylesheet" href="main.css">
</head>

<body>

	<div id="overlay">
		<button id="startButton">Play</button>
	</div>

	
	<div id="info">
		<div id="counts"></div>
	</div>
	<script src="js/three.min.js"></script>
	<script src="js/jquery-2.1.4.min.js"></script>
	<script src="js/OrbitControls.js"></script>
	<script src="js/KeyboardState.js"></script>
	<script src="https://unpkg.com/@tonejs/midi"></script>

	<script>

		var SCREEN_WIDTH = window.innerWidth;
		var SCREEN_HEIGHT = window.innerHeight;
		var aspect = SCREEN_WIDTH / SCREEN_HEIGHT;

		var camera, scene, renderer;
		var container;
        
        var clock = new THREE.Clock(), begin = false, pause = false;
        var i = 0;
    
        var spheres = [];
		var people;
        var midi, audio;
		
		var keyboard = new KeyboardState();

        class GameCreate {
            constructor(data) {
                this.node = data.tracks[0].notes;
            }            
        }

        class Sphere{
            constructor(time) {
                this.sphere = new THREE.Mesh(
                    new THREE.SphereGeometry(5, 32, 32),
                    new THREE.MeshBasicMaterial({color: "black"})
                );
                scene.add(this.sphere);
				this.sphere.position.set(0, 0, time * 50);
            }
		}

		var startButton = document.getElementById( 'startButton' );
		startButton.addEventListener( 'click', init );

		function init() {

			var overlay = document.getElementById( 'overlay' );
			overlay.remove();

			container = document.createElement('div');
			document.body.appendChild(container);

			// scene

			scene = new THREE.Scene();

			// camera

			camera = new THREE.PerspectiveCamera(30, aspect, 1, 10000);
			camera.position.set(0, 100, 100);

			// renderer

			renderer = new THREE.WebGLRenderer();
			renderer.setSize(SCREEN_WIDTH, SCREEN_HEIGHT);
			renderer.setClearColor(0xcce0ff);

			container.appendChild(renderer.domElement);

			// controls

			let controls = new THREE.OrbitControls(camera, renderer.domElement);

			// grid

			let gridXZ = new THREE.GridHelper(200, 20, 'red', 'black');
			scene.add(gridXZ)

			// resize

            window.addEventListener('resize', onWindowResize, false);
            
			people = new THREE.Mesh(
                new THREE.SphereGeometry(5, 32, 32),
                new THREE.MeshBasicMaterial({color: "red"})
            );
			scene.add(people);
			people.position.set(0, 0, 0);
			
			
			var test = ['3', '2', '1', 'GO'];
			
			var audioLoader = new THREE.AudioLoader();
			var listener = new THREE.AudioListener();
			audioLoader.load( './happy_birthday.mp3', function ( buffer ) {				
				audio = new THREE.PositionalAudio( listener );
				audio.setBuffer( buffer );
				var json = $.getJSON("test.json", function(data) {
					// load a midi file in the browser
					let midi_loader = Midi.fromUrl("./happy_birthday.mid");
					//get the tracks
					midi_loader.then((v) => {
						midi = new GameCreate(v);
					});
					console.log(midi_loader);

					setTimeout(animate, 4000);
					for( var i = 0; i <= 4; i++ ) {
						(function(x){
							window.setTimeout(function() {
								$("#counts").text(test[x]);
							}, 1000 * x);
						})(i);
					}
				});
			});
		}

		function onWindowResize() {

			SCREEN_WIDTH = window.innerWidth;
			SCREEN_HEIGHT = window.innerHeight;

			camera.aspect = SCREEN_WIDTH / SCREEN_HEIGHT;
			camera.updateProjectionMatrix();

			renderer.setSize(SCREEN_WIDTH, SCREEN_HEIGHT);

		}
		
		function animate() {
			keyboard.update();
			if (keyboard.down("esc")) {
				pause = !pause;
				if(!pause){
					clock.start()
					audio.play()
				}
				else{
					clock.stop()
					audio.pause()
				}
			}

            if(midi != undefined && !begin){
				$("#counts").text("");
				begin = true;
				clock.start()
				midi.node.forEach(function(n){
					console.log(n.time)
					spheres.push(new Sphere(n.time));
				});
				audio.play();
			}
            else if(begin && !pause){
				people.position.z += clock.getDelta()*50;
				let test = people.localToWorld(new THREE.Vector3(0, 100, -100));
				camera.position.copy(test);
				camera.lookAt(people.position.x, 0, people.position.z);
			}
    		
			requestAnimationFrame(animate);
			render();

		}

		function render() {

			renderer.render(scene, camera);

		}

	</script>
</body>

</html>